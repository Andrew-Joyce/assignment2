<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Page</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Welcome, {{ user_name }}</h1>
        <h2>Your Music Subscriptions</h2>
        <div id="subscription-area" class="subscription-area">
            {% if subscriptions %}
                {% for subscription in subscriptions %}
                <div class="subscription-item">
                    <img src="{{ subscription.img_url }}" alt="{{ subscription.artist }} image" class="artist-img">
                    <div class="music-info">
                        <h5>{{ subscription.title }}</h5>
                        <p>Artist: {{ subscription.artist }}</p>
                        <p>Year: {{ subscription.year }}</p>
                        <button class="remove-btn" data-title="{{ subscription.title }}" data-artist="{{ subscription.artist }}">Remove</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <p>No subscriptions found.</p>
            {% endif %}
        </div>
        
        <h2>Search Results</h2>
        <div class="results-area">
            {% if results %}
            <div class="results">
                {% for result in results %}
                <div class="subscription-item">
                    <img src="{{ result.img_url }}" alt="{{ result.artist }} image" class="artist-img">
                    <div class="music-info">
                        <h5>{{ result.title }}</h5>
                        <p>Artist: {{ result.artist }}</p>
                        <p>Year: {{ result.year }}</p>
                        <button class="btn btn-primary subscribe-btn" data-title="{{ result.title }}" data-artist="{{ result.artist }}" data-img="{{ result.img_url }}">Subscribe</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>No search results found.</p>
            {% endif %}
        </div>

        <h2>Search for Music</h2>
        <form action="/search" method="post" class="form-inline">
            <input type="text" name="title" placeholder="Title" class="form-control mb-2 mr-sm-2">
            <input type="text" name="artist" placeholder="Artist" class="form-control mb-2 mr-sm-2">
            <input type="text" name="year" placeholder="Year" class="form-control mb-2 mr-sm-2">
            <button type="submit" class="btn btn-primary mb-2">Query</button>
        </form>

        <a href="/logout" class="btn btn-secondary mt-2">Logout</a>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.subscribe-btn').forEach(function(btn) {
            btn.addEventListener('click', function(event) {
                event.preventDefault();
                var item = this.closest('.subscription-item'); 
                var title = this.getAttribute('data-title');
                var artist = this.getAttribute('data-artist');
                var img_url = this.getAttribute('data-img');
                subscribeToMusic(title, artist, img_url, item); 
            });
        });
    });

    function subscribeToMusic(title, artist, img_url, item) {
        fetch('/subscribe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title: title, artist: artist, img_url: img_url })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.success);
                document.getElementById('subscription-area').appendChild(item);
                item.querySelector('.btn-primary').classList.replace('btn-primary', 'remove-btn');
                item.querySelector('.remove-btn').textContent = 'Remove';
                item.querySelector('.remove-btn').addEventListener('click', function(event) {
                    event.preventDefault();
                    removeSubscription(title, artist, item);
                });
            } else {
                throw new Error(data.error || 'Failed to subscribe to music');
            }
        })
        .catch(error => {
            console.error('Error subscribing to music:', error);
            alert('Error subscribing to music: ' + error.message);
        });
    }
        

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.remove-btn').forEach(function(btn) {
        btn.addEventListener('click', function(event) {
            event.preventDefault();
            var title = this.getAttribute('data-title');
            var artist = this.getAttribute('data-artist');
            var subscriptionItem = this.closest('.subscription-item');

            console.log("Requesting removal of subscription:", title, "by", artist);
            removeSubscription(title, artist, subscriptionItem); 
        });
    });
});

function removeSubscription(title, artist, subscriptionItem) {
    console.log("Attempting to remove subscription for:", title, artist);

    fetch('/remove_subscription', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ title: title, artist: artist })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            console.log("Removal successful for:", title, artist);
            alert("Subscription successfully removed.");
            if (subscriptionItem) {
                subscriptionItem.remove(); 
            }
        } else {
            console.error("Failed to remove subscription:", data.error);
            alert("Failed to remove subscription: " + data.error);
        }
    })
    .catch(error => {
        console.error("Error removing subscription:", error);
        alert("Error removing subscription: " + error.message);
    });
}
    </script>
</body>
</html>
